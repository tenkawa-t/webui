<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Processing Pipeline</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; }
        .container { display: flex; flex-wrap: wrap; }
        .image-container, .pipeline-container, .params-container { flex: 1 1 300px; margin-right: 20px; margin-bottom: 20px; }
        .button-group { margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
        .button-group h3 { margin-top: 0; }
        button { margin: 5px; padding: 10px; }
        img { max-width: 100%; height: auto; }
        #pipeline { list-style-type: none; padding: 0; }
        #pipeline li { margin-bottom: 10px; padding: 10px; background-color: #f4f4f4; }
        #params-form { margin-top: 20px; }
        #codeDisplay {
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px solid #ddd;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .optimize-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .optimize-button:hover {
            background-color: #45a049;
        }
        .mode-button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .mode-button:hover {
            opacity: 0.8;
        }
        .mode-button.active {
            background-color: #4CAF50;
            color: white;
        }
        .mode-button:not(.active) {
            background-color: #f1f1f1;
            color: black;
        }
        #detectedClickObject {
            max-width: 100%;
            height: auto;
            display: block;
            border: 0; /* デバッグ用 */
        }
    </style>
</head>
<body>
    <h1>Image Processing Pipeline</h1>
    <div class="container">
        <div class="image-container">
            <h2>Original Image</h2>
            <input type="file" id="imageInput" accept="image/*">
            <img id="originalImage" src="" alt="Original Image">
            <h2>Processed Image</h2>
            <img id="processedImage" src="" alt="Processed Image">
            <!-- <img id="processedImage" src="" alt="Processed Image" onclick="getCoordinates(event)"> -->
        </div>
        <div class="pipeline-container">
            <h2>Processing Pipeline</h2>
            <ul id="pipeline"></ul>
            <div class="button-group">
                <h3>Basic Operations</h3>
                <button onclick="addOperation('grayscale')">Add Grayscale</button>
                <button onclick="addOperation('blur')">Add Blur</button>
                <button onclick="addOperation('edge_detection')">Add Edge Detection</button>
                <button onclick="addOperation('threshold')">Add Threshold</button>
                <button onclick="addOperation('circle_detection')">Add Circle Detection</button>
                <button onclick="addOperation('line_detection')">Add Line Detection</button>
            </div>
            <div class="button-group">
                <h3>Object Detection</h3>
                <button onclick="addOperation('yolov5')">Add YOLOv5</button>
                <button onclick="addOperation('yolox')">Add YOLOX</button>
                <button onclick="addOperation('yolov8')">Add YOLOv8</button>
            </div>
            <div class="button-group">
                <h3>Segmentation</h3>
                <button onclick="addOperation('fastsam')">Add FastSAM</button>
            </div>
            <div class="button-group">
                <h3>Classification</h3>
                <button onclick="addOperation('resnet')">Add ResNet</button>
            </div>
            <div class="button-group">
                <h3>Anomaly Detection</h3>
                <button onclick="addOperation('autoencoder')">Add AutoEncoder</button>
            </div>
            <div class="button-group">
                <h3>Pipeline Control</h3>
                <button onclick="processPipeline()">Process Image</button>
                <button onclick="savePipeline()">Save Pipeline</button>
                <button onclick="loadPipeline()">Load Pipeline</button>
            </div>
        </div>
        <div class="params-container">
            <h2>Operation Parameters</h2>
            <div id="params-form"></div>
            <label for="n-trials">Number of trials:</label>
            <input type="number" id="n-trials" value="10" min="1" max="100">
            <button class="optimize-button" onclick="optimizeParameters()">Optimize Parameters</button>
            <div class="button-group">
                <h3>Detection Display Mode</h3>
                <button id="circle-mode" class="mode-button active" onclick="setDetectionMode('circle')">Circumscribed Circle</button>
                <button id="bbox-mode" class="mode-button" onclick="setDetectionMode('bbox')">Bounding Box</button>
                <button id="mask-mode" class="mode-button" onclick="setDetectionMode('mask')">Segmentation Mask</button>
            </div>
            <h2>Detected Click Object</h2>
            <!-- <img id="detectedClickObject" src="" alt="Detected Click Object">
            <img id="detectedClickObject" src="" alt="Detected Click Object" onclick="getCoordinates(event)" style="display: none;">
            <div id="allClickedObjects"></div> -->
            <img id="detectedClickObject" src="" alt="Detected Object" style="display:none;">
            <div id="allClickedObjects"></div>
            <button onclick="clearClickedObjects()">Clear All</button>
            <button onclick="clearSelectedRegions()" style="display: none;" id="clearRegionsButton">Clear Selected Regions</button>
            <div id="optimization-progress" style="display: none;">
                <h3>Optimization Progress</h3>
                <progress id="progress-bar" value="0" max="100"></progress>
                <span id="progress-percentage">0%</span>
            </div>
            <h3>Detected Object Info</h3>
            <ul id="detectedObjectInfo"></ul>
            <button onclick="clearAllObjects()">Clear All Objects</button>
        </div>
        <div class="code-container">
            <h2>Processing Code</h2>
            <pre id="codeDisplay"></pre>
        </div>
    </div>

    <script>
        let pipeline = [];
        let clickedObjects = [];
        let allObjectInfo = [];  // すべてのオブジェクト情報を保持するグローバル変数
        function addOperation(operation) {
            let params = {};
            switch(operation) {
                case 'blur':
                    params = {ksize: 5, sigmaX: 0};
                    break;
                case 'edge_detection':
                    params = {threshold1: 100, threshold2: 200};
                    break;
                case 'threshold':
                    params = {thresh: 127, maxval: 255, type: 0};
                    break;
                case 'circle_detection':
                    params = {
                        dp: 1,
                        minDist: 50,
                        param1: 200,
                        param2: 100,
                        min_radius: 0,  // minRadius から min_radius に変更
                        max_radius: 0   // maxRadius から max_radius に変更
                    };
                    break;
                case 'line_detection':
                    params = {
                        canny_threshold1: 50,
                        canny_threshold2: 150,
                        rho: 1,
                        theta: Math.PI / 180,
                        threshold: 100,
                        minLineLength: 50,
                        maxLineGap: 10
                    };
                    break;
                // 他の操作にはデフォルトのパラメータを設定しない
            }
            pipeline.push({operation, params});
            updatePipelineView();
            showParams(pipeline.length - 1);
        }

        function updatePipelineView() {
            const pipelineElement = document.getElementById('pipeline');
            pipelineElement.innerHTML = '';
            pipeline.forEach((step, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${step.operation}`;
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.onclick = () => removeOperation(index);
                li.appendChild(removeButton);
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.onclick = () => showParams(index);
                li.appendChild(editButton);
                pipelineElement.appendChild(li);
            });
        }

        function removeOperation(index) {
            pipeline.splice(index, 1);
            updatePipelineView();
            document.getElementById('params-form').innerHTML = '';
        }

        function showParams(index) {
            const form = document.getElementById('params-form');
            form.innerHTML = '';
            const operation = pipeline[index].operation;
            const params = pipeline[index].params;

            for (const [key, value] of Object.entries(params)) {
                const label = document.createElement('label');
                label.textContent = key;
                const input = document.createElement('input');
                input.type = 'number';
                input.step = key === 'theta' ? '0.01' : '1';  // thetaの場合は小数点以下の入力を許可
                input.value = value;
                input.onchange = (e) => {
                    pipeline[index].params[key] = parseFloat(e.target.value);
                };
                form.appendChild(label);
                form.appendChild(input);
                form.appendChild(document.createElement('br'));
            }
        }
        function processPipeline() {
            const input = document.getElementById('imageInput');
            const file = input.files[0];
            if (!file) {
                alert('Please select an image first.');
                return;
            }
            // 新しい画像がアップロードされたので、キャッシュをリセット
            fetch('/reset_processed_image', { method: 'POST' })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Cache reset response:", data);
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('originalImage');
                    img.src = e.target.result;

                    fetch('/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: e.target.result, pipeline: pipeline }),
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const processedImg = document.getElementById('processedImage');
                        processedImg.src = 'data:image/jpeg;base64,' + data.image;
                        
                        const detectedClickObject = document.getElementById('detectedClickObject');
                        detectedClickObject.src = originalImage.src;  // 初期状態ではprocessedImageと同じ画像を設定
                        detectedClickObject.style.display = 'block';
                        detectedClickObject.onclick = getCoordinates;
                        
                        const clearRegionsButton = document.getElementById('clearRegionsButton');
                        clearRegionsButton.style.display = 'block';
                        
                        const codeDisplay = document.getElementById('codeDisplay');
                        if (data.code) {
                            codeDisplay.textContent = data.code
                        } else {
                            codeDisplay.textContent = 'No code available';
                        }
                })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while processing the image: ' + error.message);
               });
            };
            reader.readAsDataURL(file);
        })
        .catch((error) => {
            console.error('Error resetting processed image cache:', error);
            alert('An error occurred while resetting the image cache: ' + error.message);
        });
        }

        function savePipeline() {
            const name = prompt("Enter a name for this pipeline:");
            if (name) {
                localStorage.setItem(name, JSON.stringify(pipeline));
                alert(`Pipeline "${name}" saved successfully!`);
            }
        }

        function loadPipeline() {
            const name = prompt("Enter the name of the pipeline to load:");
            if (name) {
                const savedPipeline = localStorage.getItem(name);
                if (savedPipeline) {
                    pipeline = JSON.parse(savedPipeline);
                    updatePipelineView();
                    alert(`Pipeline "${name}" loaded successfully!`);
                } else {
                    alert(`Pipeline "${name}" not found.`);
                }
            }
        }

        // function optimizeParameters() {
        //     try {
        //         console.log("optimizeParameters function called");
        //         const currentOperation = pipeline[pipeline.length - 1].operation;
        //         console.log("Current operation:", currentOperation);
        //         const input = document.getElementById('imageInput');
        //         const file = input.files[0];
        //         if (!file) {
        //             console.error("No file selected");
        //             alert('Please select an image first.');
        //             return;
        //         }

        //         const reader = new FileReader();
        //         reader.onload = function(e) {
        //             console.log("File read successfully");
        //             console.log("Request data:", { image: e.target.result, operation: currentOperation });
        //             fetch('/optimize_parameters', {
        //                 method: 'POST',
        //                 headers: { 'Content-Type': 'application/json' },
        //                 body: JSON.stringify({ image: e.target.result, operation: currentOperation }),
        //             })
        //             .then(response => {
        //                 console.log("Received response:", response);
        //                 console.log("Response:", response);
        //                 console.log("Response status:", response.status);
        //                 console.log("Response ok:", response.ok);
        //                 if (!response.ok) {
        //                     return response.text().then(text => {
        //                         throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
        //                     });
        //                 }
        //                 return response.json();
        //             })
        //             .then(data => {
        //                 console.log('Optimization started:', data);
        //                 alert('Optimization started. This may take a while.');
        //                 checkOptimizationStatus(currentOperation);
        //             })
        //             .catch((error) => {
        //                 console.error('Error:', error);
        //                 alert('An error occurred while starting optimization: ' + error.message);
        //             });
        //         };
        //         reader.readAsDataURL(file);
        //     }catch (error) {
        //     console.error("Error in optimizeParameters:", error);
        //     }
        // }

        function optimizeParameters() {
            console.log("optimizeParameters function called");
            const currentOperation = pipeline[pipeline.length - 1].operation;
            console.log("Current operation:", currentOperation);
            const input = document.getElementById('imageInput');
            const file = input.files[0];
            if (!file) {
                console.error("No file selected");
                alert('Please select an image first.');
                return;
            }

            const nTrials = parseInt(document.getElementById('n-trials').value, 10);
            if (isNaN(nTrials) || nTrials < 1 || nTrials > 10000) {
                alert('Please enter a valid number of trials (1-10000).');
                return;
            }

            updateProgressBar(0);  // 最適化開始時に進捗バーを表示

            const reader = new FileReader();
            reader.onload = function(e) {
                console.log("File read successfully");
                console.log("Request data:", { image: e.target.result, operation: currentOperation, n_trials: nTrials });

                fetch('/optimize_parameters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image: e.target.result, 
                        operation: currentOperation,
                        n_trials: nTrials,
                        object_info: allObjectInfo  // 全てのオブジェクト情報を送信
                    }),
                })
                .then(response => {
                    console.log("Received response:", response);
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Optimization started:', data);
                    alert('Optimization started. This may take a while.');
                    checkOptimizationStatus(currentOperation);
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('An error occurred while starting optimization: ' + error.message);
                    hideProgressBar();
                });
            };
            reader.readAsDataURL(file);
        }

        function checkOptimizationStatus(operation) {
            console.log('Checking optimization status for:', operation);
            fetch(`/optimization_result/${operation}`)
            .then(response => {
                console.log("Received response:", response);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Optimization status:', data);
                console.log('Progress:', data.progress);  // 進捗状況をログ出力
                updateProgressBar(data.progress);
                if (data.status === 'completed') {
                    updateParamsWithOptimizedValues(data.best_params);
                    hideProgressBar();
                } else if (data.status === 'in_progress') {
                    console.log('Optimization still in progress, checking again in 1 second');
                    setTimeout(() => checkOptimizationStatus(operation), 1000);  // 更新間隔を1秒に短縮
                } else {
                    console.log('Unexpected optimization status:', data.status);
                    alert('Optimization has not started or encountered an error.');
                    hideProgressBar();
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while checking optimization status: ' + error.message);
                hideProgressBar();
            });
        }

        function checkOptimizationStatus(operation) {
            console.log('Checking optimization status for:', operation);
            fetch(`/optimization_result/${operation}`)
            .then(response => {
                console.log("Received response:", response);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Optimization status:', data);
                updateProgressBar(data.progress);
                if (data.status === 'completed') {
                    updateParamsWithOptimizedValues(data.best_params);
                    hideProgressBar();
                } else if (data.status === 'in_progress') {
                    console.log('Optimization still in progress, checking again in 5 seconds');
                    setTimeout(() => checkOptimizationStatus(operation), 5000);
                } else {
                    console.log('Unexpected optimization status:', data.status);
                    alert('Optimization has not started or encountered an error.');
                    hideProgressBar();
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while checking optimization status: ' + error.message);
                hideProgressBar();
            });
        }

        function updateProgressBar(progress) {
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            document.getElementById('optimization-progress').style.display = 'block';
            progressBar.value = progress;
            progressPercentage.textContent = `${progress}%`;
        }

        function hideProgressBar() {
            document.getElementById('optimization-progress').style.display = 'none';
        }

        function updateParamsWithOptimizedValues(bestParams) {
            const currentOperation = pipeline[pipeline.length - 1].operation;
            pipeline[pipeline.length - 1].params = bestParams;
            showParams(pipeline.length - 1);
            alert('Optimization completed. Parameters have been updated.');
        }
        let currentDetectionMode = 'circle';  // デフォルトは円

        let lastClickX, lastClickY;  // 最後にクリックされた座標を保存

        function setDetectionMode(mode) {
            currentDetectionMode = mode;
            
            // すべてのボタンから'active'クラスを削除
            document.querySelectorAll('.mode-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // 選択されたモードのボタンに'active'クラスを追加
            document.getElementById(`${mode}-mode`).classList.add('active');

            // もし既に検出されたオブジェクトがある場合、新しいモードで再描画
            if (document.getElementById('detectedClickObject').src && lastClickX !== undefined && lastClickY !== undefined) {
                getDetectedClickObject(lastClickX, lastClickY);
            } else {
                console.log("No previous click coordinates available");
            }
        }

        // function getCoordinates(event) {
        //     const image = event.target;
        //     const rect = image.getBoundingClientRect();
        //     const x = event.clientX - rect.left;
        //     const y = event.clientY - rect.top;
            
        //     // 画像の実際のサイズとDOM上のサイズの比率を計算
        //     const scaleX = image.naturalWidth / rect.width;
        //     const scaleY = image.naturalHeight / rect.height;
            
        //     // スケールを適用して実際の座標を計算
        //     const actualX = Math.round(x * scaleX);
        //     const actualY = Math.round(y * scaleY);
            
        //     getDetectedClickObject(actualX, actualY);  // getNearestObjectをgetDetectedClickObjectに変更
        // }
        function getCoordinates(event) {
            const image = event.target;
            const rect = image.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            const scaleX = image.naturalWidth / rect.width;
            const scaleY = image.naturalHeight / rect.height;
            
            lastClickX = Math.round(x * scaleX);
            lastClickY = Math.round(y * scaleY);
            
            console.log("Clicked coordinates:", lastClickX, lastClickY); // デバッグ用ログ
            
            getDetectedClickObject(lastClickX, lastClickY);
        }

        // function getDetectedClickObject(x, y) {
        //     console.log("getDetectedClickObject called");
        //     console.log("Arguments:", x, y, currentDetectionMode);

        //     const detectedClickObject = document.getElementById('detectedClickObject');    
        //     fetch('/get_nearest_object', {
        //         method: 'POST',
        //         headers: { 'Content-Type': 'application/json' },
        //         body: JSON.stringify({ 
        //             image: detectedClickObject.src,
        //             x: x,
        //             y: y,
        //             mode: currentDetectionMode 
        //         }),
        //     })
        //     .then(response => {
        //         console.log("Response status:", response.status);

        //         if (!response.ok) {
        //             return response.text().then(text => {
        //                 throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
        //             });
        //         }
        //         return response.json();
        //     })
        //     .then(data => {
        //         console.log("Received data:", data);
        //         if (data.image) {
        //             console.log("Image data size:", data.image.length);
        //             detectedClickObject.src = 'data:image/jpeg;base64,' + data.image;
        //             detectedClickObject.style.display = 'block';
        //             console.log("Image src set to:", detectedClickObject.src.substring(0, 100) + "...");
            
        //             // 画像のロードを確認
        //             detectedClickObject.onload = function() {
        //                 console.log("Image loaded successfully");
        //             };
        //             detectedClickObject.onerror = function() {
        //                 console.error("Error loading image");
        //             };
        //         } else {
        //             console.log("No image data received");
        //             alert(data.message || 'No object found near the specified coordinates.');
        //         }
        //     })
        //     .catch((error) => {
        //         console.error('Error:', error);
        //         alert('An error occurred while getting the detected click object: ' + error.message);
        //     });
        // }
        function getDetectedClickObject(x, y) {
            console.log("getDetectedClickObject called");
            console.log("Arguments:", x, y, currentDetectionMode);

            const originalImage = document.getElementById('originalImage');
            
            fetch('/get_nearest_object', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    image: originalImage.src,
                    x: x,
                    y: y,
                    mode: currentDetectionMode,
                    clickedObjects: clickedObjects
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log("Received data:", data);
                if (data.image) {
                    console.log("Image data size:", data.image.length);
                // オブジェクト情報をリセット
                allObjectInfo = []; // ここでリセットします

                // 新しいオブジェクトを追加
                clickedObjects.push({
                    x: x,
                    y: y,
                    mode: currentDetectionMode
                });

                const detectedClickObject = document.getElementById('detectedClickObject');
                if (detectedClickObject) {
                    detectedClickObject.src = 'data:image/jpeg;base64,' + data.image;
                    detectedClickObject.style.display = 'block';
                } else {
                    console.error("detectedClickObject element not found");
                }

                // object_info を allObjectInfo に追加
                if (data.object_info) {
                    data.object_info.forEach(newObjInfo => {
                        allObjectInfo.push(newObjInfo); // 新しいオブジェクト情報を全て追加
                    });
                }
                displayDetectedObjectInfo(allObjectInfo); // リセット後のデータを表示
                    // // 新しいオブジェクトを追加
                    // clickedObjects.push({
                    //     x: x,
                    //     y: y,
                    //     mode: currentDetectionMode
                    // });


                    // const detectedClickObject = document.getElementById('detectedClickObject');
                    // if (detectedClickObject) {
                    //     detectedClickObject.src = 'data:image/jpeg;base64,' + data.image;
                    //     detectedClickObject.style.display = 'block';
                    // } else {
                    //     console.error("detectedClickObject element not found");
                    // }
                    // // object_info を allObjectInfo に追加する前に重複チェック
                    // if (data.object_info) {
                    //     data.object_info.forEach(newObjInfo => {
                    //         // 既存データを確認し、存在する場合は更新、存在しない場合は追加
                    //         const existingIndex = findExistingObjectIndex(newObjInfo, allObjectInfo);
                    //         if (existingIndex === -1) {
                    //             allObjectInfo.push(newObjInfo); // 新規オブジェクトを追加
                    //         } else {
                    //             allObjectInfo[existingIndex] = newObjInfo; // 既存オブジェクトを更新
                    //         }
                    //     });
                    // }

                    // const newObject = { x: x, y: y, mode: currentDetectionMode };
                    // const isDuplicate = clickedObjects.some(obj => 
                    //     obj.x === newObject.x && obj.y === newObject.y && obj.mode === newObject.mode
                    // );
                    // console.log(newObject);
                    // console.log(allObjectInfo);
                    // if (!isDuplicate) {
                    //     clickedObjects.push(newObject);
                    // }

                    // const detectedClickObject = document.getElementById('detectedClickObject');
                    // detectedClickObject.src = 'data:image/jpeg;base64,' + data.image;
                    // detectedClickObject.style.display = 'block';

                    // // object_info を allObjectInfo に追加する前に重複チェック
                    // if (data.object_info) {
                    //     data.object_info.forEach(newObjInfo => {
                    //         const existingIndex = findExistingObjectIndex(newObjInfo, allObjectInfo);
                    //         if (existingIndex === -1) {
                    //             allObjectInfo.push(newObjInfo); // 重複していない場合に追加
                    //         } else {
                    //             allObjectInfo[existingIndex] = newObjInfo; // 重複している場合に更新
                    //         }
                    //     });
                    // }
                    // displayDetectedObjectInfo(allObjectInfo);
                    // ログ出力
                    logClickedObjects();
                } else {
                    console.log("No image data received");
                    alert('No object found near the specified coordinates.');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while getting the detected click object: ' + error.message);
            });
        }
        function displayDetectedObjectInfo(objectInfo) {
            const detectedObjectInfoElement = document.getElementById('detectedObjectInfo');
            detectedObjectInfoElement.innerHTML = ''; // 一度クリア

            objectInfo.forEach((info, index) => {
                const li = document.createElement('li');
                let objectDetails = `Object ${index + 1}: (${info.x}, ${info.y}) - ${info.mode}`;
                
                if (info.mode === 'circle') {
                    objectDetails += `, Center: (${info.cx}, ${info.cy}), Radius: ${info.radius}`;
                } else if (info.mode === 'bbox') {
                    objectDetails += `, Bounding Box: (${info.x}, ${info.y}, ${info.width}, ${info.height})`;
                }
                
                li.textContent = objectDetails;
                detectedObjectInfoElement.appendChild(li);
            });
        }
        // 既存のオブジェクト情報があるか確認する関数
        function findExistingObjectIndex(newObjectInfo, allObjectInfo) {
            const threshold = 5;  // 許容する座標のズレ (ピクセル単位)
            for (let i = 0; i < allObjectInfo.length; i++) {
                const existingObject = allObjectInfo[i];
                const distance = Math.sqrt(
                    Math.pow(existingObject.cx - newObjectInfo.cx, 2) + Math.pow(existingObject.cy - newObjectInfo.cy, 2)
                );
                if (distance < threshold && existingObject.mode === newObjectInfo.mode) {
                    return i;  // 既存のオブジェクトが見つかった場合、そのインデックスを返す
                }
            }
            return -1;  // 見つからない場合は -1 を返す
        }
        function clearAllObjects() {
            allObjectInfo = [];  // 全てのオブジェクト情報をリセット
            clickedObjects = [];  // クリックされたオブジェクトもリセット
            document.getElementById('detectedObjectInfo').innerHTML = '';  // 表示をクリア
        }
        function isObjectAlreadyAdded(newObjectInfo, allObjectInfo) {
            // 座標の微妙な違いを許容しつつ、重複チェックを行う
            const threshold = 5;  // 許容する座標のズレ (ピクセル単位)
            return allObjectInfo.some(info => {
                const distance = Math.sqrt(
                    Math.pow(info.cx - newObjectInfo.cx, 2) + Math.pow(info.cy - newObjectInfo.cy, 2)
                );
                return distance < threshold && info.mode === newObjectInfo.mode;
            });
        }
        // function getDetectedClickObject(x, y) {
        //     console.log("getDetectedClickObject called");
        //     console.log("Arguments:", x, y, currentDetectionMode);
        //     const detectedClickObject = document.getElementById('detectedClickObject');
        //     const originalImage = document.getElementById('originalImage');
            
        //     fetch('/get_nearest_object', {
        //         method: 'POST',
        //         headers: { 'Content-Type': 'application/json' },
        //         body: JSON.stringify({ 
        //             image: originalImage.src,
        //             x: x,
        //             y: y,
        //             mode: currentDetectionMode,
        //             clickedObjects: clickedObjects  // 過去のクリックオブジェクトを送信
        //         }),
        //     })
        //     .then(response => response.json())
        //     .then(data => {
        //         console.log("Received data:", data);
        //         if (data.image) {
        //             console.log("Image data size:", data.image.length);
        //             const img = document.createElement('img');
        //             img.onload = function() {
        //                 console.log("Image loaded successfully");
        //                 console.log("Image dimensions:", this.width, "x", this.height);
        //             };
        //             img.src = 'data:image/jpeg;base64,' + data.image;
                    
        //             // 既存の画像要素を更新
        //             const detectedClickObject = document.getElementById('detectedClickObject');
        //             detectedClickObject.src = img.src;
        //             detectedClickObject.style.display = 'block';

        //             // 新しい画像要素を追加
        //             document.body.appendChild(img);

        //             // clickedObjects 配列に追加
        //             clickedObjects.push({
        //                 image: data.image,
        //                 x: x,
        //                 y: y
        //             });

        //             // ログ出力
        //             logClickedObjects();
        //     // .then(data => {
        //     //     console.log("Received data:", data);
        //     //     if (data.image) {
        //     //         const detectedClickObject = document.getElementById('detectedClickObject');
        //     //         detectedClickObject.onload = function() {
        //     //             console.log("Image loaded successfully");
        //     //             console.log("Image dimensions:", this.width, "x", this.height);
        //     //         };
        //     //         detectedClickObject.onerror = function() {
        //     //             console.error("Error loading image");
        //     //         };
        //     //         detectedClickObject.src = 'data:image/jpeg;base64,' + data.image;
        //     //         detectedClickObject.style.display = 'block';

        //     //         // 新しい画像要素を作成して追加
        //     //         const newImg = document.createElement('img');
        //     //         newImg.src = 'data:image/jpeg;base64,' + data.image;
        //     //         newImg.style.maxWidth = '100%';
        //     //         newImg.style.height = 'auto';
        //     //         document.body.appendChild(newImg);
        //     //         const newTab = window.open();
        //     //         newTab.document.body.innerHTML = '<img src="data:image/jpeg;base64,' + data.image + '">';
        //     //         // 最新のオブジェクトを表示
        //     //         // displayDetectedObject(data.image);
                    
        //     //         // すべてのオブジェクトを表示
        //     //         displayAllClickedObjects();
        //     //         logClickedObjects();  // ここでログを出力
        //         } else {
        //             console.log("No image data received");
        //         }
        //     })
        //     .catch((error) => {
        //         console.error('Error:', error);
        //     });
        // }
        // function getDetectedClickObject(x, y) {
        //     console.log("getDetectedClickObject called");
        //     console.log("Arguments:", x, y, currentDetectionMode);

        //     const detectedClickObject = document.getElementById('detectedClickObject');  
        //     const processedImage = document.getElementById('processedImage');  
        //     fetch('/get_nearest_object', {
        //         method: 'POST',
        //         headers: { 'Content-Type': 'application/json' },
        //         body: JSON.stringify({ 
        //             image: detectedClickObject.src,
        //             // image: processedImage.src,
        //             x: x,
        //             y: y,
        //             mode: currentDetectionMode 
        //         }),
        //     })
        //     .then(response => {
        //         console.log("Response status:", response.status);
        //         if (!response.ok) {
        //             throw new Error(`HTTP error! status: ${response.status}`);
        //         }
        //         return response.json();
        //     })
        //     .then(data => {
        //         console.log("Received data:", data);
        //         if (data.image) {
        //             console.log("Image data size:", data.image.length);
        //             const img = new Image();
        //             img.onload = () => {
        //                 console.log("Image loaded successfully");
        //                 detectedClickObject.src = img.src;
        //                 detectedClickObject.style.display = 'block';
        //             };
        //             img.onerror = () => {
        //                 console.error("Error loading image");
        //             };
        //             img.src = 'data:image/jpeg;base64,' + data.image;
        //         // console.log("Received data:", data);
        //         // if (data.image) {
        //         //     console.log("Image data size:", data.image.length);
        //         //     detectedClickObject.src = 'data:image/jpeg;base64,' + data.image;
        //         //     detectedClickObject.style.display = 'block';
        //         //     console.log("Image src set to:", detectedClickObject.src.substring(0, 100) + "...");
        //         } else {
        //             console.log("No image data received");
        //             alert('No object found near the specified coordinates.');
        //         }
        //     })
        //     .catch((error) => {
        //         console.error('Error:', error);
        //         alert('An error occurred while getting the detected click object: ' + error.message);
        //     });
        // }
        function displayDetectedObject(imageData) {
            const detectedClickObject = document.getElementById('detectedClickObject');
            detectedClickObject.src = 'data:image/jpeg;base64,' + imageData;
            detectedClickObject.style.display = 'block';
        }

        function displayDetectedObject(imageData, x, y, mode, index) {
            const container = document.getElementById('detectedObjects');

            const objContainer = document.createElement('div');
            objContainer.className = 'detected-object';

            const img = document.createElement('img');
            img.src = 'data:image/jpeg;base64,' + imageData;
            img.alt = `Clicked Object ${index}`;
            img.style.maxWidth = '200px';
            img.style.height = 'auto';

            const info = document.createElement('p');
            info.textContent = `Object ${index}: (${x}, ${y}) - ${mode}`;

            objContainer.appendChild(img);
            objContainer.appendChild(info);
            container.appendChild(objContainer);
        }

        function clearDetectedObjects() {
            clickedObjects = [];
            const detectedObjectsImage = document.getElementById('detectedObjectsImage');
            detectedObjectsImage.style.display = 'none';
        }

        function logClickedObjects() {
            console.log("Current clickedObjects:");
            clickedObjects.forEach((obj, index) => {
                console.log(`Object ${index + 1}: (${obj.x}, ${obj.y}) - ${obj.mode}`);
            });
        }
        function clearDetectedObjects() {
            clickedObjects = [];
            const detectedClickObject = document.getElementById('detectedClickObject');
            if (detectedClickObject) {
                detectedClickObject.style.display = 'none';
            }
        }

        function clearSelectedRegions() {
            fetch('/clear_selected_regions', {
                method: 'POST',
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                // Clear the nearest object image
                const nearestObjectImage = document.getElementById('nearestObjectImage');
                nearestObjectImage.src = '';
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while clearing selected regions: ' + error.message);
            });
        }
        // ページロード時にデフォルトモードを設定
        document.addEventListener('DOMContentLoaded', function() {
            setDetectionMode('bbox');  // デフォルトモードを'bbox'に設定
        });
        </script>
</body>
</html>
